# BEwithU n8n工作流文档

## 概述

BEwithU系统使用n8n作为工作流编排引擎，实现智能化的IT支持流程自动化。本文档详细介绍了系统中的四个核心工作流。

## 工作流架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端应用      │    │   n8n工作流     │    │   后端API       │
│                 │    │                 │    │                 │
│ • 用户界面      │◄──►│ • 智能问答      │◄──►│ • 知识库        │
│ • 聊天界面      │    │ • 工单自动化    │    │ • 用户管理      │
│ • 工单管理      │    │ • 知识管理      │    │ • 系统监控      │
│ • 知识库       │    │ • 系统监控      │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │   Ollama LLM    │
                       │                 │
                       │ • 本地AI模型    │
                       │ • 智能问答      │
                       │ • 内容生成      │
                       └─────────────────┘
```

## 核心工作流

### 1. 智能问答工作流 (Intelligent Q&A Workflow)

**功能：** 处理用户问题，通过知识库搜索和LLM生成智能回答

**触发方式：** Webhook (POST /webhook/intelligent-qa)

**工作流程：**
1. 接收用户问题和元数据
2. 验证输入数据
3. 在知识库中搜索相关信息
4. 根据搜索结果准备LLM上下文
5. 调用Ollama LLM生成回答
6. 保存对话记录
7. 返回智能回答

**输入参数：**
```json
{
  "question": "用户问题",
  "user_id": "用户ID",
  "language": "ja|zh|en",
  "conversation_id": "会话ID"
}
```

**输出结果：**
```json
{
  "success": true,
  "answer": "AI生成的回答",
  "has_knowledge_match": true,
  "knowledge_articles": [...],
  "suggest_ticket_creation": false,
  "timestamp": "2025-01-14T10:00:00.000Z"
}
```

### 2. 工单自动化工作流 (Ticket Automation Workflow)

**功能：** 自动化工单创建、分类、优先级分析和分配

**触发方式：** Webhook (POST /webhook/ticket-automation)

**工作流程：**
1. 接收工单创建请求
2. 分析内容并自动分类
3. 基于关键词确定优先级
4. 创建工单记录
5. 根据优先级决定分配策略
6. 自动分配给合适的支持人员
7. 发送通知给相关人员

**智能功能：**
- **自动分类：** 基于关键词识别硬件、软件、网络等类别
- **优先级分析：** 识别紧急、重要关键词自动调整优先级
- **智能分配：** 高优先级工单优先分配给管理员

**输入参数：**
```json
{
  "title": "工单标题",
  "description": "问题描述",
  "priority": "normal|high|urgent",
  "category": "分类（可选）",
  "user_id": "用户ID",
  "language": "ja|zh|en"
}
```

### 3. 知识库管理工作流 (Knowledge Management Workflow)

**功能：** 自动从已解决工单和对话中提取知识，生成知识库文章

**触发方式：**
- 定时触发：每日凌晨2点自动运行
- 手动触发：Webhook (POST /webhook/knowledge-extract)

**自动知识提取流程：**
1. 获取已关闭的工单
2. 分析工单内容和解决方案
3. 检查是否已存在类似知识
4. 使用LLM生成结构化文章
5. 创建知识库草稿

**手动知识提取流程：**
1. 接收会话ID
2. 获取完整对话记录
3. 提取问题和解答
4. 生成知识库文章
5. 保存为草稿待审核

**知识提取标准：**
- 工单必须包含明确的问题和解决方案
- 对话必须包含有价值的问答内容
- 自动去重，避免重复知识

### 4. 系统监控工作流 (System Monitoring Workflow)

**功能：** 监控系统健康状态，生成告警和周报

**监控频率：**
- 健康检查：每5分钟
- 周报生成：每周一上午9点

**监控服务：**
- **数据库：** PostgreSQL连接状态
- **LLM服务：** Ollama API可用性
- **缓存：** Redis连接状态
- **工作流：** n8n服务状态
- **API：** 后端API响应时间

**告警机制：**
- **Critical：** 服务完全不可用，立即通知管理员
- **Warning：** 性能下降或部分功能异常
- **Healthy：** 服务正常运行

**周报内容：**
- 系统统计数据
- 服务健康状况
- 性能指标
- 异常事件汇总

## 部署和配置

### 1. 环境准备

```bash
# 复制环境配置
cp n8n/.env.example n8n/.env

# 编辑配置文件
vim n8n/.env
```

### 2. 工作流导入

```bash
# 运行部署脚本
./n8n/deploy-workflows.sh
```

### 3. 凭据配置

在n8n界面中配置以下凭据：
- BEwithU API认证令牌
- 数据库连接信息
- 邮件服务配置（可选）

### 4. Webhook配置

在前端应用中配置以下Webhook端点：
```javascript
const N8N_WEBHOOKS = {
  intelligentQA: 'http://n8n:5678/webhook/intelligent-qa',
  ticketAutomation: 'http://n8n:5678/webhook/ticket-automation',
  knowledgeExtract: 'http://n8n:5678/webhook/knowledge-extract'
};
```

## 监控和维护

### 1. 工作流状态检查

- 访问n8n管理界面：http://localhost:5678
- 检查工作流执行历史
- 查看错误日志和性能指标

### 2. 常见问题排查

**工作流执行失败：**
- 检查服务连接状态
- 验证API凭据配置
- 查看详细错误日志

**LLM响应超时：**
- 检查Ollama服务状态
- 调整超时配置
- 监控模型加载状态

**数据库连接问题：**
- 验证数据库服务状态
- 检查连接字符串配置
- 查看数据库日志

### 3. 性能优化

**工作流优化：**
- 调整并发执行数量
- 优化数据处理逻辑
- 使用缓存减少重复请求

**LLM优化：**
- 选择合适的模型大小
- 调整上下文长度
- 实现响应缓存

## 扩展和定制

### 1. 添加新工作流

1. 创建工作流JSON文件
2. 添加到workflows目录
3. 更新部署脚本
4. 配置相关凭据

### 2. 自定义节点

1. 开发自定义n8n节点
2. 打包为npm包
3. 在Docker镜像中安装
4. 在工作流中使用

### 3. 集成外部服务

- 邮件通知服务
- 短信告警服务
- 第三方监控平台
- 企业IM系统

## 安全考虑

### 1. 访问控制

- 启用n8n基本认证
- 配置HTTPS访问
- 限制网络访问范围

### 2. 数据保护

- 敏感数据加密存储
- 定期备份工作流配置
- 审计日志记录

### 3. API安全

- 使用JWT令牌认证
- 实现请求频率限制
- 验证输入数据格式

## 总结

BEwithU的n8n工作流系统提供了完整的IT支持自动化解决方案，通过智能问答、工单自动化、知识管理和系统监控四个核心工作流，实现了从用户问题到解决方案的全流程自动化。

系统具有以下特点：
- **智能化：** 基于LLM的智能问答和内容生成
- **自动化：** 工单分类、分配和知识提取全自动化
- **可监控：** 完整的系统健康监控和告警机制
- **可扩展：** 模块化设计，易于添加新功能
- **多语言：** 支持中日英三语言处理

通过合理的配置和维护，该系统能够显著提升IT支持效率，减少人工干预，提供更好的用户体验。

